<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>Memos Display</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jkjoy/memos/css/style.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jkjoy/memos@latest/css/uno.css">
<script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.css" />    
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link rel="stylesheet" href="https://cdn.imsun.org/lxgw-wenkai-screen-webfont/lxgwwenkaigbscreen.css" />
</head>
<body>
    <div class="bg-[#f0f0f0]">
        <div> 
            <div class="bg-white mx-auto main-container">
                <header class="top">
                    <div class="fixed top-0 left-0 w-full h-14 z-9">
                        <div class="main-container mx-auto flex flex-row justify-between h-full transition-all duration-300" id="top-fixed">
                            <div class="flex items-center">
                               <span class="h-full px-5 flex items-center">  </span>
                            </div>
                            <div class="flex items-center">
                                 <span class="h-full px-5 flex items-center">  </span>
                            </div>
                        </div>
                    </div>
             
                  
                    
                        <div class="top-1">
                            <div class="flex flex-row items-end">
                                    <a href="/"> <img src="https://img.imsun.org/avatar.jpg" /></a>
                            </div>
                        </div>
                        <div class="top-2"> 
                            <div class="flex flex-row items-end">老孙</div>  </div>
                       
               
                </header>
                <div class="article-container">
                    <div id="memos-container"></div>
                    <button id="load-more" class="load-more-btn">加载更多</button>
                </div>
            </div>
        </div>
    </div>
<script>
window.onload = function() {
    let offset = 0; // 初始偏移量
    const limit = 10; // 每次加载的数量

    function formatHTML(memosData) {
        let htmlString = '';      
        memosData.forEach(memo => {
            const { content, resources, uid, createTime } = memo;
            let resourceElement = ''; // 初始化资源相关HTML为空字符串
            // 尝试从memo内容中匹配图片URL
            const imageUrlMatch = content.match(/\((https?.+?\.(?:jpeg|jpg|gif|png))\)/i);
            let imageUrl = "";
            if (imageUrlMatch && imageUrlMatch.length > 1) {
                imageUrl = imageUrlMatch[1];
                resourceElement += `<a href="${imageUrl}" target="_blank"><img src="${imageUrl}" data-fancybox="img" class="thumbnail-image img"></a>`;
            }
            if (resources && resources.length > 0) {
                resources.forEach(resource => {
                    if (resource.externalLink && !imageUrl) { // 如果已经找到图片URL，则跳过
                        // 检查链接是否为图片文件
                        if (/\.(jpeg|jpg|gif|png|bmp|webp)/i.test(resource.externalLink)) {
                            // 是图片资源，创建图片标签
                            resourceElement += `<a href="${resource.externalLink}" target="_blank"><img src="${resource.externalLink}" data-fancybox="img" class="thumbnail-image img"></a>`;
                        } else {
                            // 不是图片资源，创建超链接标签
                            resourceElement += `<a href="${resource.externalLink}" target="_blank">点击下载</a>`;
                        }
                    }
                });
            }
                // 使用 marked 转换 markdown 内容为 HTML
                const htmlContent = marked.parse(content.replace(/#(.*?)\s/g, '') // 移除井号到空白字符的内容
                                             .replace(/\!?\[(.*?)\]\((.*?)\)/g, '') // 移除Markdown风格的链接或图片
                                          ); // 移除花括号内的内容
                // 创建 memo HTML 字符串，包括图片和内容
                htmlString += `
                    <article class="flex flex-row border-b border-b-2 dark:border-gray-800 border-gray-200 pt-5 pl-5 pr-5">
                        <div class="mr-3">
                            <div class="w-9 h-9">
                               <img src="https://img.imsun.org/avatar.jpg" class="w-9 h-9 object-cover rounded-lg preview-image" />
                            </div>
                        </div>
                        <div class="w-full border-t-0 border-l-0 border-r-0 border-b-1 dark:border-gray-800 border-gray-100 border-solid pb-1">
                            <section class="flex flex-row justify-between items-center mb-1">
                                <span class="text-color-link cursor-default text-[14px]">
                                    <a href="https://memos.ee/u/jkjoy" target="_blank" class="cursor-pointer text-color-link no-underline">浪子</a>
                                </span>
                            </section> 
                            <section class="mb-1 cursor-default break-all line-clamp">
                                <p>${htmlContent}</p>
                                <div class="resimg">${resourceElement}</div>
                                <div class="text-gray text-xs"><a href="https://memos.ee/m/${uid}" target="_blank" class="cursor-pointer text-color-link no-underline">${new Date(createTime).toLocaleString()}</a></div>
                            </section> 
                        </div>
                    </article>`;
            });
            return htmlString;
        }

        function fetchMemos() {
            return fetch('https://bbapi.memos.ee')
                .then(response => response.json())
                .then(data => data.memos)
                .catch(error => {
                    console.error('Error fetching memos:', error);
                    return [];
                });
        }

        function fetchAndDisplayMemos() {
            fetchMemos().then(data => {
                const memosContainer = document.getElementById('memos-container');
                const memosToShow = data.slice(offset, offset + limit); // 选择要显示的memos
                memosContainer.innerHTML += formatHTML(memosToShow);
                offset += limit; // 更新偏移量
                // 如果没有更多的memos，隐藏“加载更多”按钮
                if (offset >= data.length) {
                    document.getElementById('load-more').style.display = 'none';
                }
            });
        }

        // 在页面加载完成后获取并展示 memos
        fetchAndDisplayMemos();

        // 绑定“加载更多”按钮的点击事件
        document.getElementById('load-more').addEventListener('click', fetchAndDisplayMemos);
    };

    Fancybox.bind("[data-fancybox]", {
  // Your custom options
});
</script>         
</body>
</html>
